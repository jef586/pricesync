// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE AUTHENTICATION & AUTHORIZATION SCHEMA
// ============================================================================

enum UserRole {
  SUPERADMIN
  ADMIN
  SUPERVISOR
  SELLER
  TECHNICIAN
}

enum UserStatus {
  active
  inactive
  suspended
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  avatarUrl    String?    @map("avatar_url")
  role         UserRole   @default(SELLER)
  status       UserStatus @default(active)

  // Relaciones
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  lastLogin DateTime? @map("last_login")

  // Configuración personal
  preferences Json   @default("{}")
  timezone    String @default("America/Argentina/Buenos_Aires")

  // Relaciones
  sessions UserSession[]
  passwordResets PasswordReset[]

  @@index([companyId], map: "idx_users_company")
  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model Permission {
  id          String  @id @default(cuid())
  name        String  @unique // 'billing:create', 'inventory:read'
  description String?
  module      String // 'core', 'auto-parts', 'retail'

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  role         UserRole
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([role, permissionId])
  @@map("role_permissions")
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash   String   @map("token_hash")
  refreshHash String   @map("refresh_hash")
  expiresAt   DateTime @map("expires_at")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_sessions")
}

// Tokens de reseteo de contraseña (un solo uso)
model PasswordReset {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId], map: "idx_password_resets_user")
  @@map("password_resets")
}

// ============================================================================
// AUDIT LOGS SCHEMA
// ============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String
  actorName   String
  targetId    String?
  targetName  String?
  actionType  String   // e.g., USER_CREATE, USER_UPDATE, ROLE_UPDATE
  payloadDiff Json?
  companyId   String?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([companyId, createdAt], map: "idx_audit_company_created")
  @@index([targetId, createdAt], map: "idx_audit_target_created")
  @@map("audit_logs")
}

// ============================================================================
// CORE COMPANIES SCHEMA
// ============================================================================

enum CompanyStatus {
  active
  inactive
  suspended
}

model Company {
  id      String  @id @default(cuid())
  name    String
  taxId   String  @unique @map("tax_id") // CUIT/RUT/NIT
  email   String?
  phone   String?
  address String?
  city    String?
  state   String?
  country String  @default("AR") // ISO 3166-1 alpha-2
  zipCode String? @map("zip_code")

  status CompanyStatus @default(active)

  // Configuración fiscal
  fiscalConfig Json @default("{}") @map("fiscal_config")

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relaciones
  users                  User[]
  customers              Customer[]
  articles               Article[]
  invoices               Invoice[]
  categories             Category[]
  suppliers              Supplier[]
  // Ventas
  salesOrders            SalesOrder[]
  importJobs             ImportJob[]
  Warehouse              Warehouse[]
  StockMovement          StockMovement[]
  StockBalance           StockBalance[]
  SupplierPreset         SupplierPreset[]
  // Stock estimator settings
  stockEstimatorSettings StockEstimatorSettings[]
  // Taxes relations
  taxRules               TaxRule[]
  taxPeriodTotals        TaxPeriodTotal[]
  documentTaxLines       DocumentTaxLine[]

  @@map("companies")
}

// ============================================================================
// REPORTS SCHEMA (Print logs)
// ============================================================================

model PrintLog {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  printerName String?  @map("printer_name")
  status      String   @map("status")
  attempts    Int      @default(1) @map("attempts")
  userId      String?  @map("user_id")
  companyId   String?  @map("company_id")
  branchId    String?  @map("branch_id")
  message     String?  @map("message")
  printedAt   DateTime @default(now()) @map("printed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("print_logs")
}

// ============================================================================
// CORE CUSTOMERS SCHEMA (CRM)
// ============================================================================

enum CustomerType {
  individual
  business
}

enum CustomerStatus {
  active
  inactive
  blocked
}

model Customer {
  id     String         @id @default(cuid())
  code   String // Código interno del cliente
  name   String
  type   CustomerType   @default(individual)
  status CustomerStatus @default(active)

  // Información fiscal
  taxId       String? @map("tax_id") // CUIT/DNI/RUT/NIT
  taxCategory String? @map("tax_category") // Responsable Inscripto, Monotributo, etc.

  // Contacto
  email   String?
  phone   String?
  mobile  String?
  website String?

  // Dirección
  address String?
  city    String?
  state   String?
  country String  @default("AR")
  zipCode String? @map("zip_code")

  // Comercial
  creditLimit  Decimal? @map("credit_limit") @db.Decimal(10, 2)
  paymentTerms Int?     @map("payment_terms") // días
  discount     Decimal? @default(0) @db.Decimal(5, 2) // porcentaje

  // Relaciones
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relaciones
  invoices        Invoice[]
  // Ventas
  salesOrders     SalesOrder[]
  LoyaltyAccount  LoyaltyAccount?
  LoyaltyMovement LoyaltyMovement[]

  @@unique([companyId, code])
  @@map("customers")
}

// ============================================================================
// CORE INVENTORY SCHEMA
// ============================================================================

// Tipos para Artículos y recursos asociados
enum ArticleType {
  PRODUCT
  SERVICE
}

enum InternalTaxType {
  NONE
  FIXED
  PERCENT
}

enum BarcodeType {
  EAN13
  EAN8
  UPCA
  CODE128
  PLU
  CUSTOM
}

enum UoM {
  UN
  BU
  KG
  LT
}

// Bulk pricing modes for wholesale tiers
enum BulkPriceMode {
  UNIT_PRICE
  PERCENT_OFF
}

model Category {
  id          String     @id @default(cuid())
  name        String
  description String?
  parentId    String?    @map("parent_id")
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  // Campos jerárquicos y de configuración
  level      Int      @default(0)
  path       String?
  isActive   Boolean  @default(true) @map("is_active")
  marginRate Decimal? @default(0.00) @map("margin_rate") @db.Decimal(5, 2)
  deletedAt  DateTime? @map("deleted_at")

  // Relaciones
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  articles Article[]

  @@unique([companyId, name, parentId], map: "uniq_categories_company_name_parent", name: "unique_company_name_parent")
  @@index([parentId], map: "idx_categories_parent_id")
  @@index([path], map: "idx_categories_path")
  @@index([isActive], map: "idx_categories_is_active")
  @@index([companyId, isActive], map: "idx_categories_company_active")
  @@map("categories")
}

model Article {
  id     String      @id @default(cuid())
  name   String
  type   ArticleType @default(PRODUCT)
  active Boolean     @default(true)

  // Identificación
  sku         String       @unique
  barcode     String?      @unique
  barcodeType BarcodeType? @map("barcode_type")

  // Clasificación
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id])

  // Impuestos y precios
  taxRate     Decimal  @default(21) @map("tax_rate") @db.Decimal(5, 2)
  cost        Decimal? @db.Decimal(12, 2)
  gainPct     Decimal? @map("gain_pct") @db.Decimal(7, 3)
  pricePublic Decimal  @map("price_public") @db.Decimal(12, 2)

  // Inventario
  stock        Int     @default(0)
  stockMin     Int?    @map("stock_min")
  stockMax     Int?    @map("stock_max")
  controlStock Boolean @default(false) @map("control_stock")

  // Descripción y medios
  description String?
  imageUrl    String?       @map("image_url")
  imageId     String?       @unique @map("image_id")
  image       ArticleImage? @relation("PrimaryArticleImage", fields: [imageId], references: [id], onDelete: SetNull)

  // Impuesto interno
  internalTaxType  InternalTaxType @default(NONE) @map("internal_tax_type")
  internalTaxValue Decimal         @default(0) @map("internal_tax_value") @db.Decimal(12, 4)

  // Flags fiscales
  subjectIIBB      Boolean @default(false) @map("subject_iibb")
  subjectGanancias Boolean @default(false) @map("subject_ganancias")
  subjectPercIVA   Boolean @default(false) @map("subject_perc_iva")

  // Fidelización
  pointsPerUnit Decimal? @default(0) @map("points_per_unit") @db.Decimal(10, 3)

  // Relaciones
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relaciones
  invoiceItems           InvoiceItem[]
  supplierProducts       SupplierProduct[]
  salesOrderItems        SalesOrderItem[]
  barcodes               ArticleBarcode[]
  suppliers              ArticleSupplier[]
  bundleComponents       ArticleBundleComponent[] @relation("ArticleBundleComponents")
  uoms                   ArticleUom[]
  wholesaleTiers         ArticleWholesaleTier[]
  ArticleBundleComponent ArticleBundleComponent[]
  StockMovement          StockMovement[]
  StockBalance           StockBalance[]
  images                 ArticleImage[]           @relation("ArticleImages")
  ArticleBulkPricing     ArticleBulkPricing[]
  ArticleDemandStats     ArticleDemandStats[]
  // Precios fijos por listas L1–L3 (UH-ART-26)
  fixedPrices            ArticlePricesFixed?
  // Back-relation for quantity promotions (UH-ART-25)
  qtyPromotions          ArticleQuantityPromotion[] @relation("ArticleQuantityPromotion")

  @@index([imageId], map: "idx_articles_image")
  @@index([companyId], map: "idx_articles_company")
  @@index([categoryId], map: "idx_articles_category")
  @@map("articles")
}

model ArticleImage {
  id         String   @id @default(cuid())
  articleId  String   @map("article_id")
  article    Article  @relation("ArticleImages", fields: [articleId], references: [id], onDelete: Cascade)
  primaryFor Article? @relation("PrimaryArticleImage")

  imageUrl     String  @map("image_url")
  thumbnailUrl String? @map("thumbnail_url")

  mimeType  String? @map("mime_type")
  sizeBytes Int?    @map("size_bytes")
  width     Int?
  height    Int?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([articleId], map: "idx_article_images_article")
  @@map("article_images")
}

model ArticleBarcode {
  id        String      @id @default(cuid())
  articleId String      @map("article_id")
  article   Article     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  code      String      @unique
  type      BarcodeType

  createdAt DateTime @default(now()) @map("created_at")

  @@map("article_barcodes")
}

model ArticleSupplier {
  id          String   @id @default(cuid())
  articleId   String   @map("article_id")
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  supplierId  String   @map("supplier_id")
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  isPrimary   Boolean  @default(false) @map("is_primary")
  supplierSku String   @map("supplier_sku")

  @@unique([articleId, supplierId])
  @@unique([supplierId, supplierSku])
  @@map("article_suppliers")
}

model ArticleBundleComponent {
  id                 String  @id @default(cuid())
  articleId          String  @map("article_id") // combo
  article            Article @relation("ArticleBundleComponents", fields: [articleId], references: [id], onDelete: Cascade)
  componentArticleId String  @map("component_article_id")
  componentArticle   Article @relation(fields: [componentArticleId], references: [id], onDelete: Cascade)
  qty                Decimal @db.Decimal(12, 3)

  @@unique([articleId, componentArticleId])
  @@map("article_bundle_components")
}

model ArticleUom {
  id            String   @id @default(cuid())
  articleId     String   @map("article_id")
  article       Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  uom           UoM
  factor        Decimal  @db.Decimal(12, 6)
  priceOverride Decimal? @map("price_override") @db.Decimal(12, 2)

  @@unique([articleId, uom])
  @@map("article_uoms")
}

model ArticleWholesaleTier {
  id          String    @id @default(cuid())
  articleId   String    @map("article_id")
  article     Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  uom         UoM
  minQty      Decimal   @map("min_qty") @db.Decimal(12, 3)
  price       Decimal?  @db.Decimal(12, 2)
  discountPct Decimal?  @map("discount_pct") @db.Decimal(7, 3)
  active      Boolean   @default(true)
  validFrom   DateTime? @map("valid_from")
  validTo     DateTime? @map("valid_to")

  @@index([articleId], map: "idx_wholesale_article")
  @@map("article_wholesale_tiers")
}

// Quantity promotions per article (UH-ART-25)
model ArticleQuantityPromotion {
  id            String   @id @default(cuid())
  articleId     String   @map("article_id")
  article       Article  @relation("ArticleQuantityPromotion", fields: [articleId], references: [id], onDelete: Cascade)
  active        Boolean  @default(true)
  exclusive     Boolean  @default(false)
  priceListIds  Json     @map("price_list_ids")
  startsAt      DateTime? @map("starts_at")
  endsAt        DateTime? @map("ends_at")
  createdBy     String?  @map("created_by")
  updatedBy     String?  @map("updated_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tiers ArticleQuantityPromoTier[]

  @@index([articleId], map: "idx_article_qty_promo_article")
  @@index([articleId, active, startsAt, endsAt], map: "idx_article_qty_promo_filters")
  @@map("article_quantity_promotions")
}

model ArticleQuantityPromoTier {
  id           String  @id @default(cuid())
  promotionId  String  @map("promotion_id")
  promotion    ArticleQuantityPromotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  minQtyUn     Decimal @map("min_qty_un") @db.Decimal(12, 3)
  pricePerUnit Decimal? @map("price_per_unit") @db.Decimal(12, 2)
  percentOff   Decimal? @map("percent_off") @db.Decimal(5, 2)
  sort         Int

  @@unique([promotionId, sort])
  @@map("article_quantity_promo_tiers")
}

// New article bulk pricing table (UH-ART-19)
model ArticleBulkPricing {
  id         String        @id @default(cuid())
  articleId  String        @map("article_id")
  article    Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  uom        UoM           @map("uom_code")
  minQty     Decimal       @map("min_qty") @db.Decimal(12, 3)
  mode       BulkPriceMode
  unitPrice  Decimal?      @map("unit_price") @db.Decimal(12, 2)
  percentOff Decimal?      @map("percent_off") @db.Decimal(5, 2)
  priority   Int           @default(0)
  active     Boolean       @default(true)
  validFrom  DateTime?     @map("valid_from")
  validTo    DateTime?     @map("valid_to")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")
  deletedAt  DateTime?     @map("deleted_at")

  @@index([articleId, uom, minQty, priority], map: "idx_article_bulk_pricing_rule")
  @@map("article_bulk_pricing")
}

// Fixed price lists per article (UH-ART-26)
model ArticlePricesFixed {
  id         String   @id @default(cuid())
  articleId  String   @map("article_id")
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  // Lista 1 (Minorista)
  l1MarginPct  Decimal? @map("l1_margin_pct") @db.Decimal(7, 3)
  l1FinalPrice Decimal? @map("l1_final_price") @db.Decimal(12, 2)
  l1Locked     Boolean  @map("l1_locked") @default(false)

  // Lista 2 (Mayorista 1)
  l2MarginPct  Decimal? @map("l2_margin_pct") @db.Decimal(7, 3)
  l2FinalPrice Decimal? @map("l2_final_price") @db.Decimal(12, 2)
  l2Locked     Boolean  @map("l2_locked") @default(false)

  // Lista 3 (Mayorista 2)
  l3MarginPct  Decimal? @map("l3_margin_pct") @db.Decimal(7, 3)
  l3FinalPrice Decimal? @map("l3_final_price") @db.Decimal(12, 2)
  l3Locked     Boolean  @map("l3_locked") @default(false)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([articleId])
  @@map("article_prices_fixed")
}

// ============================================================================
// CORE BILLING SCHEMA
// ============================================================================

enum InvoiceType {
  A // Factura A
  B // Factura B
  C // Factura C
  E // Factura E (Exportación)
  M // Factura M (Monotributo)
}

enum InvoiceStatus {
  draft
  pending
  sent
  paid
  overdue
  cancelled
}

// Recargo final en documentos de facturación
enum SurchargeType {
  PERCENT
  ABS
}

model Invoice {
  id     String        @id @default(cuid())
  number String // Número de factura
  type   InvoiceType   @default(B)
  status InvoiceStatus @default(draft)

  // Fechas
  issueDate DateTime  @map("issue_date")
  dueDate   DateTime? @map("due_date")
  paidDate  DateTime? @map("paid_date")

  // Importes
  subtotal        Decimal        @db.Decimal(10, 2)
  taxAmount       Decimal        @map("tax_amount") @db.Decimal(10, 2)
  total           Decimal        @db.Decimal(10, 2)
  // Recargo final (auditoría)
  surchargeType   SurchargeType? @map("surcharge_type")
  surchargeValue  Decimal        @default(0) @map("surcharge_value") @db.Decimal(12, 2)
  surchargeAmount Decimal        @default(0) @map("surcharge_amount") @db.Decimal(12, 2)

  // Observaciones
  notes String?

  // Información fiscal
  fiscalData Json? @map("fiscal_data") // CAE, CAI, etc.

  // Relaciones
  companyId  String   @map("company_id")
  company    Company  @relation(fields: [companyId], references: [id])
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relaciones
  items    InvoiceItem[]
  taxLines DocumentTaxLine[]

  @@unique([companyId, number])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  description String? // Descripción personalizada del item
  quantity    Decimal @db.Decimal(10, 3)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(5, 2) // porcentaje
  taxRate     Decimal @map("tax_rate") @db.Decimal(5, 2)

  // Calculados
  subtotal  Decimal @db.Decimal(10, 2)
  taxAmount Decimal @map("tax_amount") @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  invoiceId String   @map("invoice_id")
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  articleId String?  @map("article_id") // Hacer opcional para permitir items sin artículo
  article   Article? @relation(fields: [articleId], references: [id])

  // Snapshot de precio/impuestos/UoM
  articleName String? @map("article_name")
  sku         String?
  barcode     String?

  uom       UoM     @map("uom")
  uomFactor Decimal @map("uom_factor") @db.Decimal(12, 6)
  qty       Decimal @map("qty") @db.Decimal(12, 3)
  qtyUn     Decimal @map("qty_un") @db.Decimal(12, 3)

  unitPriceNet   Decimal @map("unit_price_net") @db.Decimal(10, 2)
  unitPriceGross Decimal @map("unit_price_gross") @db.Decimal(10, 2)

  internalTaxType  InternalTaxType? @map("internal_tax_type")
  internalTaxValue Decimal?         @map("internal_tax_value") @db.Decimal(12, 2)

  vatRate       Decimal       @map("vat_rate") @db.Decimal(5, 2)
  discountType  DiscountType? @map("discount_type")
  discountValue Decimal       @default(0) @map("discount_value") @db.Decimal(12, 2)
  discountTotal Decimal       @default(0) @map("discount_total") @db.Decimal(10, 2)

  subtotalNet    Decimal @map("subtotal_net") @db.Decimal(10, 2)
  taxTotal       Decimal @map("tax_total") @db.Decimal(10, 2)
  lineTotalGross Decimal @map("line_total_gross") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([invoiceId], map: "idx_invoice_items_invoice")
  @@index([articleId], map: "idx_invoice_items_article")
  @@map("invoice_items")
}

// ============================================================================
// SUPPLIERS SCHEMA
// ============================================================================

enum SupplierStatus {
  active
  inactive
  blocked
}

model Supplier {
  id           String  @id @default(cuid())
  code         String // Código interno del proveedor
  name         String
  businessName String? @map("business_name") // Razón social
  taxId        String? @map("tax_id") // CUIT/RUT/Tax ID

  // Información de contacto
  email   String?
  phone   String?
  website String?

  // Dirección
  address    String?
  city       String?
  state      String?
  postalCode String? @map("postal_code")
  country    String? @default("Argentina")

  // Estado y configuración
  status       SupplierStatus @default(active)
  paymentTerms Int?           @map("payment_terms") // Días de pago
  creditLimit  Decimal?       @map("credit_limit") @db.Decimal(12, 2)

  // Información adicional
  notes String?
  tags  String[] @default([])

  // Relaciones
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Auditoria
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relaciones
  products        SupplierProduct[]
  importJobs      ImportJob[]
  ArticleSupplier ArticleSupplier[]
  SupplierPreset  SupplierPreset[]

  @@unique([companyId, code])
  @@unique([companyId, taxId])
  @@map("suppliers")
}

model SupplierProduct {
  id String @id @default(cuid())

  // Información del proveedor
  supplierCode String  @map("supplier_code") // Código del producto en el proveedor
  supplierName String  @map("supplier_name") // Nombre del producto según el proveedor
  description  String? // Descripción adicional

  // Precios y condiciones
  costPrice   Decimal  @map("cost_price") @db.Decimal(10, 2)
  listPrice   Decimal? @map("list_price") @db.Decimal(10, 2) // Precio de lista
  currency    String   @default("ARS")
  minQuantity Int?     @map("min_quantity") // Cantidad mínima de compra

  // Información técnica (para autopartes)
  brand String?
  model String?
  year  String?
  oem   String? // Número OEM

  // Estado y disponibilidad
  isActive    Boolean @default(true) @map("is_active")
  isAvailable Boolean @default(true) @map("is_available")
  leadTime    Int?    @map("lead_time") // Tiempo de entrega en días

  // Relaciones
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  productId  String?  @map("product_id") // Legacy: vínculo opcional
  product    Article? @relation(fields: [productId], references: [id])

  // Auditoria
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  lastImportDate DateTime? @map("last_import_date") // Fecha de última importación

  @@unique([supplierId, supplierCode])
  @@map("supplier_products")
}

// ============================================================================
// CORE SALES SCHEMA
// ============================================================================

enum SalesOrderStatus {
  open
  partially_paid
  parked
  paid
  draft
  completed
  cancelled
}

// Descuento por ítem en ventas
enum DiscountType {
  PERCENT
  ABS
}

model SalesOrder {
  id     String @id @default(cuid())
  number String @unique

  // Importes
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @map("tax_amount") @db.Decimal(10, 2)
  discountAmount  Decimal       @map("discount_amount") @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  totalRounded    Decimal       @map("total_rounded") @db.Decimal(10, 2)
  paidTotal       Decimal       @default(0) @map("paid_total") @db.Decimal(10, 2)
  // Recargo final de la venta
  surchargeType   DiscountType? @map("surcharge_type")
  surchargeValue  Decimal       @default(0) @map("surcharge_value") @db.Decimal(12, 2)
  surchargeAmount Decimal       @default(0) @map("surcharge_amount") @db.Decimal(12, 2)

  status SalesOrderStatus @default(open)
  notes  String?

  // Relaciones
  companyId  String   @map("company_id")
  company    Company  @relation(fields: [companyId], references: [id])
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  // Auditoría
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parking
  parkToken String?   @map("park_token")
  parkedAt  DateTime? @map("parked_at")

  // Relaciones
  items           SalesOrderItem[]
  payments        SalesPayment[]
  taxLines        DocumentTaxLine[]
  LoyaltyMovement LoyaltyMovement[]

  @@unique([companyId, number])
  @@unique([parkToken], map: "uniq_sales_orders_park_token")
  @@index([parkedAt], map: "idx_sales_orders_parked_at")
  @@map("sales_orders")
}

model SalesOrderItem {
  id          String  @id @default(cuid())
  description String?
  quantity    Decimal @db.Decimal(10, 3)
  uom         UoM?
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(5, 2)
  taxRate     Decimal @map("tax_rate") @db.Decimal(5, 2)

  // Descuentos por ítem (coexistentes con descuento final de la venta)
  discountType   DiscountType? @map("discount_type")
  discountValue  Decimal       @default(0) @map("discount_value") @db.Decimal(12, 2)
  discountTotal  Decimal       @default(0) @map("discount_total") @db.Decimal(12, 2)
  isDiscountable Boolean       @default(true) @map("is_discountable")

  // Calculados
  subtotal  Decimal @db.Decimal(10, 2)
  taxAmount Decimal @map("tax_amount") @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Relaciones
  salesOrderId String     @map("sales_order_id")
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  articleId    String?    @map("article_id")
  article      Article?   @relation(fields: [articleId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sales_order_items")
}

model SalesPayment {
  id            String   @id @default(cuid())
  method        String
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("ARS")
  reference     String?
  paidAt        DateTime @map("paid_at")
  methodDetails Json?    @map("method_details")

  // Relaciones
  salesOrderId String     @map("sales_order_id")
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("sales_payments")
}

// ============================================================================
// LOYALTY SCHEMA
// ============================================================================

enum LoyaltyMovementType {
  EARN
  REVERSE
}

model LoyaltyAccount {
  id            String   @id @default(cuid())
  customerId    String   @map("customer_id")
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  pointsBalance Decimal  @default(0) @map("points_balance") @db.Decimal(12, 3)
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([customerId], map: "uniq_loyalty_accounts_customer")
  @@map("loyalty_accounts")
}

model LoyaltyMovement {
  id         String              @id @default(cuid())
  customerId String              @map("customer_id")
  customer   Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  saleId     String?             @map("sale_id")
  sale       SalesOrder?         @relation(fields: [saleId], references: [id], onDelete: SetNull)
  type       LoyaltyMovementType
  points     Decimal             @db.Decimal(12, 3)
  reason     String?
  createdAt  DateTime            @default(now()) @map("created_at")

  @@index([customerId], map: "idx_loyalty_movements_customer")
  @@index([saleId], map: "idx_loyalty_movements_sale")
  @@map("loyalty_movements")
}

// Añadir dirección y razones de stock
enum StockDirection {
  IN
  OUT
}

// ============================================================================
// STOCK ESTIMATOR (Demand & Settings)
// ============================================================================

// Ámbito de configuración del estimador (global o por proveedor)
enum StockEstimatorScope {
  GLOBAL
  SUPPLIER
}

// Cache de demanda por artículo (promedios diarios y métricas)
model ArticleDemandStats {
  /// FK/PK al artículo
  articleId String  @id @map("article_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  avg7            Decimal   @default(0) @db.Decimal(12, 4)
  avg30           Decimal   @default(0) @db.Decimal(12, 4)
  avg90           Decimal   @default(0) @db.Decimal(12, 4)
  lastSaleAt      DateTime? @map("last_sale_at")
  volatilityIndex Decimal   @default(0) @map("volatility_index") @db.Decimal(8, 4)

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("article_demand_stats")
}

// Configuración del estimador (lead/safety/coverage) por empresa
model StockEstimatorSettings {
  id String @id @default(cuid())

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  scope   StockEstimatorScope
  scopeId String?             @map("scope_id")

  leadTimeDays    Int @default(5) @map("lead_time_days")
  safetyStockDays Int @default(3) @map("safety_stock_days")
  coverageDays    Int @default(14) @map("coverage_days")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, scope, scopeId], map: "uniq_stock_estimator_settings_scope")
  @@map("stock_estimator_settings")
}

enum StockReason {
  PURCHASE_IN
  SALE_OUT
  RETURN_IN
  RETURN_OUT
  ADJUST_IN
  ADJUST_OUT
  TRANSFER_IN
  TRANSFER_OUT
  COMBO_CONSUME
  COMBO_REVERT
}

model Warehouse {
  id   String  @id @default(cuid())
  name String
  code String? @unique

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  stockBalances  StockBalance[]
  stockMovements StockMovement[]

  @@map("warehouses")
}

model StockMovement {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  articleId String  @map("article_id")
  article   Article @relation(fields: [articleId], references: [id])

  warehouseId String?    @map("warehouse_id")
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  uom       UoM
  qty       Decimal        @db.Decimal(12, 3)
  qtyUn     Decimal        @map("qty_un") @db.Decimal(12, 3)
  direction StockDirection
  reason    StockReason

  documentId        String? @map("document_id")
  documentType      String? @map("document_type")
  comment           String?
  override          Boolean @default(false)
  clientOperationId String? @map("client_operation_id")

  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([companyId, clientOperationId], map: "uniq_stock_movements_client_op")
  @@index([articleId, createdAt], map: "idx_stock_movements_article_created")
  @@index([warehouseId, articleId], map: "idx_stock_movements_wh_article")
  @@map("stock_movements")
}

model StockBalance {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  articleId String  @map("article_id")
  article   Article @relation(fields: [articleId], references: [id])

  warehouseId String?    @map("warehouse_id")
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  onHandUn  Decimal  @map("on_hand_un") @db.Decimal(14, 3)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, articleId, warehouseId], map: "uniq_stock_balances_company_article_wh")
  @@index([warehouseId, articleId], map: "idx_stock_balances_wh_article")
  @@map("stock_balances")
}

// ============================================================================
// IMPORT JOBS & PRESETS SCHEMA
// ============================================================================

enum ImportJobStatus {
  pending
  processing
  completed
  failed
}

model SupplierPreset {
  id          String  @id @default(cuid())
  name        String
  description String?
  isActive    Boolean @default(true) @map("is_active")

  // Target supplier (optional preset general)
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // Column→field mapping and defaults
  mapping  Json @default("{}") // e.g. { barcode:"Codigo", description:"Descripción", cost:"Costo" }
  defaults Json @default("{}") // e.g. { iva:21, internalTaxType:"NONE" }

  // Auditoría
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  importJobs ImportJob[]

  // Uniqueness: per company and supplier (optional) by name
  @@unique([companyId, supplierId, name], map: "uniq_supplier_presets_company_supplier_name")
  @@map("supplier_presets")
}

model ImportJob {
  id     String          @id @default(cuid())
  status ImportJobStatus @default(pending)

  // Archivo y preset
  fileName String          @map("file_name")
  fileHash String?         @map("file_hash")
  presetId String?         @map("preset_id")
  preset   SupplierPreset? @relation(fields: [presetId], references: [id])

  // Contexto
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  companyId  String    @map("company_id")
  company    Company   @relation(fields: [companyId], references: [id])
  startedBy  String    @map("started_by") // user id

  // Flags
  isDryRun  Boolean @default(true) @map("is_dry_run")
  chunkSize Int     @default(500) @map("chunk_size")

  // Métricas
  totalRows     Int @default(0) @map("total_rows")
  processedRows Int @default(0) @map("processed_rows")
  createdCount  Int @default(0) @map("created_count")
  updatedCount  Int @default(0) @map("updated_count")
  skippedCount  Int @default(0) @map("skipped_count")
  errorCount    Int @default(0) @map("error_count")
  warningCount  Int @default(0) @map("warning_count")

  // Enlaces/logs
  previewJson Json?   @map("preview_json")
  logCsvPath  String? @map("log_csv_path")

  // Auditoría
  startedAt  DateTime  @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@index([companyId, status], map: "idx_import_jobs_company_status")
  @@map("import_jobs")
}

// ============================================================================
// TAXES SCHEMA (Retenciones/Percepciones)
// ============================================================================

// Tipos de tributo admitidos
enum TaxType {
  IIBB_RET
  IIBB_PERC
  GAN_RET
  VAT_PERC
}

// Rol de contraparte para la aplicación de reglas
enum CounterpartyRole {
  SUPPLIER
  CUSTOMER
}

// Método de base imponible
enum BaseMethod {
  NET
  NET_PLUS_II
}

// Método de redondeo
enum RoundingMethod {
  HALF_UP
  DOWN
  UP
}

// Reglas configurables por provincia/actividad/rol
model TaxRule {
  id String @id @default(cuid())

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  provinceCode     String           @map("province_code")
  taxType          TaxType          @map("tax_type")
  activityCode     String?          @map("activity_code")
  counterpartyRole CounterpartyRole @map("counterparty_role")

  rate       Decimal        @db.Decimal(6, 4)
  baseMethod BaseMethod     @map("base_method")
  minAmount  Decimal?       @map("min_amount") @db.Decimal(12, 2)
  rounding   RoundingMethod @default(HALF_UP)

  validFrom DateTime  @map("valid_from")
  validTo   DateTime? @map("valid_to")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Back-relations
  documentTaxLines DocumentTaxLine[]

  @@index([companyId, provinceCode, taxType], map: "idx_tax_rules_company_province_type")
  @@map("tax_rules")
}

// Totales agregados por período (YYYY-MM), provincia y tipo de tributo
model TaxPeriodTotal {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  period       String // YYYY-MM
  provinceCode String  @map("province_code")
  taxType      TaxType @map("tax_type")
  amountTotal  Decimal @default(0) @map("amount_total") @db.Decimal(14, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([companyId, period, provinceCode, taxType], map: "uniq_tax_period_totals")
  @@map("tax_period_totals")
}

// Líneas de tributo aplicadas a documentos (facturas/ventas)
model DocumentTaxLine {
  id String @id @default(cuid())

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  // Referencia al documento
  invoiceId    String?     @map("invoice_id")
  invoice      Invoice?    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  salesOrderId String?     @map("sales_order_id")
  salesOrder   SalesOrder? @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  itemId       String?     @map("item_id")

  taxType          TaxType          @map("tax_type")
  provinceCode     String           @map("province_code")
  activityCode     String?          @map("activity_code")
  counterpartyRole CounterpartyRole @map("counterparty_role")

  rate       Decimal        @db.Decimal(6, 4)
  baseMethod BaseMethod     @map("base_method")
  baseAmount Decimal        @map("base_amount") @db.Decimal(12, 2)
  amount     Decimal        @db.Decimal(12, 2)
  rounding   RoundingMethod @default(HALF_UP)
  ruleId     String?        @map("rule_id")
  rule       TaxRule?       @relation(fields: [ruleId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([invoiceId], map: "idx_doc_tax_lines_invoice")
  @@index([salesOrderId], map: "idx_doc_tax_lines_sales")
  @@map("document_tax_lines")
}
